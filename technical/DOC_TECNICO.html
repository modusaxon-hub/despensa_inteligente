<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentaciÃ³n TÃ©cnica â€” Despensa Inteligente</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@400;600&family=JetBrains+Mono&display=swap');

        :root {
            --green: #2d8a4e;
            --dark: #1a1a2e;
            --accent: #e67e22;
            --blue: #2980b9;
        }

        @media print {
            @page {
                size: A4;
                margin: 2.5cm 2cm;
            }

            body {
                background: white !important;
            }

            .no-print {
                display: none;
            }

            .page-break {
                page-break-before: always;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            color: #1a1a1a;
            line-height: 1.6;
            background: #f0f2f5;
            margin: 0;
            padding: 40px;
        }

        .paper-a4 {
            background: white;
            max-width: 210mm;
            margin: 0 auto;
            padding: 30px 40px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
            color: var(--dark);
        }

        h1 {
            border-bottom: 3px solid var(--green);
            padding-bottom: 15px;
            font-size: 2em;
        }

        h2 {
            border-left: 4px solid var(--green);
            padding-left: 12px;
            margin-top: 35px;
        }

        h3 {
            color: var(--accent);
        }

        .hook {
            background: #eafaf1;
            border-left: 5px solid var(--green);
            padding: 15px;
            margin-bottom: 25px;
            font-style: italic;
        }

        .diagram-box {
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8em;
            white-space: pre;
            overflow-x: auto;
            line-height: 1.4;
            page-break-inside: avoid;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 5px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8em;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.85em;
            page-break-inside: avoid;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #2d8a4e;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
        }

        tr:nth-child(even) {
            background: #f8f8f8;
        }

        .tech-badge {
            display: inline-block;
            background: #e8f5e9;
            color: var(--green);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin: 2px;
        }

        .flow-box {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .footer {
            margin-top: 50px;
            font-size: 0.75em;
            text-align: center;
            color: #aaa;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
    </style>
</head>

<body>
    <div class="paper-a4">
        <header>
            <div
                style="color: var(--green); font-weight: bold; font-size: 0.8em; letter-spacing: 0.2em; text-transform: uppercase;">
                Despensa Inteligente â€” DocumentaciÃ³n TÃ©cnica</div>
            <h1>ğŸ“˜ Manual TÃ©cnico del Sistema</h1>
        </header>

        <div class="hook">
            <strong>PropÃ³sito:</strong> Documentar la arquitectura completa del sistema, flujos de datos, decisiones
            tÃ©cnicas y estructura de cÃ³digo. |
            <strong>Riesgo de no tenerlo:</strong> Sin este documento, cualquier cambio futuro se hace a ciegas, sin
            contexto de por quÃ© cada pieza existe.
        </div>

        <!-- â•â•â•â•â•â•â• 1. STACK TECNOLÃ“GICO â•â•â•â•â•â•â• -->
        <h2>1. Stack TecnolÃ³gico</h2>
        <table>
            <tr>
                <th>Capa</th>
                <th>TecnologÃ­a</th>
                <th>PropÃ³sito</th>
            </tr>
            <tr>
                <td>Frontend</td>
                <td><span class="tech-badge">HTML5</span> <span class="tech-badge">CSS3</span> <span
                        class="tech-badge">JavaScript</span></td>
                <td>Interfaz web responsive tipo Excel</td>
            </tr>
            <tr>
                <td>Backend API</td>
                <td><span class="tech-badge">PHP 8.x</span> <span class="tech-badge">PDO</span></td>
                <td>Endpoints REST para consulta de productos y precios</td>
            </tr>
            <tr>
                <td>Base de Datos</td>
                <td><span class="tech-badge">MySQL / MariaDB</span></td>
                <td>Almacenamiento de productos, precios e historial</td>
            </tr>
            <tr>
                <td>Scraper</td>
                <td><span class="tech-badge">Python 3.x</span> <span class="tech-badge">Playwright</span></td>
                <td>Raspado automÃ¡tico de precios de tiendas online</td>
            </tr>
            <tr>
                <td>Servidor Local</td>
                <td><span class="tech-badge">XAMPP</span></td>
                <td>Apache + MySQL para desarrollo local</td>
            </tr>
        </table>

        <!-- â•â•â•â•â•â•â• 2. ESTRUCTURA DE ARCHIVOS â•â•â•â•â•â•â• -->
        <h2>2. Estructura del Proyecto</h2>
        <div class="diagram-box">
            despensa_inteligente/
            â”œâ”€â”€ index.html â† Entrada principal (Planificador Maestro)
            â”œâ”€â”€ TASK.md â† BitÃ¡cora de tareas (formato tabla)
            â”œâ”€â”€ CHANGELOG.md â† Registro de cambios por dÃ­a
            â”‚
            â”œâ”€â”€ app/
            â”‚ â””â”€â”€ main.js â† LÃ³gica del frontend (fetch, render, cÃ¡lculos)
            â”‚
            â”œâ”€â”€ api/
            â”‚ â”œâ”€â”€ get_products.php â† GET: Lista productos con precios mÃ¡s recientes
            â”‚ â””â”€â”€ import_csv.php â† POST: Importar productos desde CSV
            â”‚
            â”œâ”€â”€ assets/
            â”‚ â””â”€â”€ style.css â† Estilos globales del planificador
            â”‚
            â”œâ”€â”€ config/
            â”‚ â””â”€â”€ db.php â† ConexiÃ³n PDO a MySQL
            â”‚
            â”œâ”€â”€ database/
            â”‚ â””â”€â”€ schema.sql â† Esquema DDL (CREATE TABLE)
            â”‚
            â”œâ”€â”€ scrapers/
            â”‚ â””â”€â”€ auto_bot.py â† Bot de scraping con Playwright
            â”‚
            â”œâ”€â”€ technical/
            â”‚ â”œâ”€â”€ Repositorio.md â† Config Git + URL remota
            â”‚ â”œâ”€â”€ ERROR_LOG.html â† Registro de errores y soluciones
            â”‚ â”œâ”€â”€ BITACORA_2026-02-15.html â† CronologÃ­a diaria
            â”‚ â”œâ”€â”€ DOC_TECNICO.html â† (Este documento)
            â”‚ â””â”€â”€ MANUAL_USUARIO.html â† GuÃ­a para el usuario final
            â”‚
            â””â”€â”€ documentation/
            â””â”€â”€ Mercado 2026 - DIC_25.csv â† Datos de importaciÃ³n original
        </div>

        <!-- â•â•â•â•â•â•â• 3. DIAGRAMA ENTIDAD-RELACIÃ“N â•â•â•â•â•â•â• -->
        <h2>3. Modelo de Datos (ERD)</h2>

        <div class="diagram-box">
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ PRODUCTOS â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ PK id INT AUTO_INC â”‚
            â”‚ nombre_personalizado VARCHAR(255) NN â”‚
            â”‚ categoria VARCHAR(100) â”‚
            â”‚ es_favorito BOOLEAN â”‚
            â”‚ cantidad_actual DECIMAL(10,2) â”‚
            â”‚ cantidad_minima DECIMAL(10,2) â”‚
            â”‚ unidad_medida_base VARCHAR(20) â”‚
            â”‚ termino_busqueda VARCHAR(100) â”‚ â† NUEVO
            â”‚ url_olimpica TEXT â”‚
            â”‚ url_d1 TEXT â”‚
            â”‚ url_ara TEXT â”‚
            â”‚ url_megatiendas TEXT â”‚
            â”‚ selector_olimpica VARCHAR(255) â”‚
            â”‚ selector_d1 VARCHAR(255) â”‚
            â”‚ selector_ara VARCHAR(255) â”‚
            â”‚ selector_megatiendas VARCHAR(255) â”‚
            â”‚ ultima_actualizacion TIMESTAMP â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ 1
            â”‚
            â”‚ N
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ PRECIOS_TIENDAS â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ PK id INT AUTO_INC â”‚
            â”‚ FK producto_id INT â†’ productos â”‚
            â”‚ tienda ENUM(D1,OLIMPICA,â”‚
            â”‚ ARA,EXITO, â”‚
            â”‚ MEGATIENDAS,OTRO)â”‚
            â”‚ precio DECIMAL(10,2) â”‚
            â”‚ cantidad_presentacion DECIMAL(10,2) â”‚
            â”‚ unidad_presentacion VARCHAR(10) â”‚
            â”‚ precio_por_unidad DECIMAL(10,4) â”‚ â† PUM
            â”‚ fecha_registro TIMESTAMP â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ (referencia lÃ³gica)
            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ HISTORIAL_COMPRAS â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ PK id INT AUTO_INC â”‚
            â”‚ FK producto_id INT â†’ productos â”‚
            â”‚ fecha_compra TIMESTAMP â”‚
            â”‚ tienda_elegida VARCHAR(50) â”‚
            â”‚ precio_pagado DECIMAL(10,2) â”‚
            â”‚ cantidad_comprada DECIMAL(10,2) â”‚
            â”‚ ahorro_estimado DECIMAL(10,2) â”‚ â† vs mÃ¡s caro
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </div>

        <h3>Relaciones</h3>
        <table>
            <tr>
                <th>RelaciÃ³n</th>
                <th>Tipo</th>
                <th>DescripciÃ³n</th>
            </tr>
            <tr>
                <td>productos â†’ precios_tiendas</td>
                <td>1:N</td>
                <td>Un producto tiene N registros de precio (uno por tienda por fecha). La API selecciona el mÃ¡s
                    reciente.</td>
            </tr>
            <tr>
                <td>productos â†’ historial_compras</td>
                <td>1:N</td>
                <td>Cada compra registrada se vincula al producto. Sirve para calcular ahorro histÃ³rico.</td>
            </tr>
        </table>

        <div class="page-break"></div>

        <!-- â•â•â•â•â•â•â• 4. FLUJO DE DATOS â•â•â•â•â•â•â• -->
        <h2>4. Flujo de Datos del Sistema</h2>

        <div class="diagram-box">
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ USUARIO â”‚
            â”‚ (Browser) â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTP GET
            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” SQL Query â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ index.html â”‚ â”€â”€â”€â”€ fetch() â”€â”€â”€â”€â–¶ â”‚ API â”‚
            â”‚ + main.js â”‚ â”‚ PHP/PDO â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
            â–² â”‚
            â”‚ JSON â”‚ SELECT
            â”‚ â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Renderizado â”‚ â”‚ MySQL â”‚
            â”‚ Tabla + $ â”‚ â”‚ BD â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
            â–²
            â”‚ INSERT
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
            â”‚ Tiendas â”‚ â—€â”€â”€ Playwright â”€â”€â–¶ â”‚ Scraper â”‚
            â”‚ D1, OlÃ­mpicaâ”‚ â”‚ auto_bot â”‚
            â”‚ Mega, ARA â”‚ â”‚ .py â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </div>

        <!-- â•â•â•â•â•â•â• 5. FLUJO DEL SCRAPER â•â•â•â•â•â•â• -->
        <h2>5. Arquitectura del Scraper</h2>

        <h3>5.1. Flujo de ejecuciÃ³n</h3>
        <div class="diagram-box">
            auto_bot.py
            â”‚
            â”œâ”€ 1. CONFIGURAR UBICACIÃ“N
            â”‚ â”œâ”€â”€ set_megatiendas_location()
            â”‚ â”‚ â””â”€â”€ localStorage.setItem('shippingData', {...})
            â”‚ â”‚
            â”‚ â””â”€â”€ set_olimpica_location()
            â”‚ â”œâ”€â”€ Â¿"Continuar"? â†’ click â†’ âœ…
            â”‚ â”œâ”€â”€ Â¿"Confirmar"? â†’ fill("centro") â†’ click â†’ âœ…
            â”‚ â””â”€â”€ Â¿Trigger? â†’ click â†’ re-check â†’ dropdowns
            â”‚
            â”œâ”€ 2. POR CADA PRODUCTO:
            â”‚ â”‚
            â”‚ â””â”€â”€ POR CADA TIENDA (D1, OlÃ­mpica, Megatiendas):
            â”‚ â”‚
            â”‚ â”œâ”€â”€ PRIORIDAD 1: Â¿termino_busqueda?
            â”‚ â”‚ â””â”€â”€ generar_variantes("aceite 3000")
            â”‚ â”‚ â†’ ["aceite 3000", "aceite 3.000",
            â”‚ â”‚ "aceite 3000ml", "aceite 3.000 ml"]
            â”‚ â”‚ â†’ buscar con TODAS las variantes
            â”‚ â”‚ â†’ combinar + deduplicar por URL
            â”‚ â”‚ â†’ seleccionar el MÃS BARATO
            â”‚ â”‚
            â”‚ â”œâ”€â”€ PRIORIDAD 2: Â¿URL fija (legacy)?
            â”‚ â”‚ â””â”€â”€ get_price(url, selector) â†’ float
            â”‚ â”‚
            â”‚ â””â”€â”€ PRIORIDAD 3: Sin datos
            â”‚ â””â”€â”€ âš  "Requiere configuraciÃ³n manual"
            â”‚
            â””â”€ 3. INSERT INTO precios_tiendas (...) VALUES (...)
        </div>

        <h3>5.2. FunciÃ³n generar_variantes() â€” Inteligencia de BÃºsqueda</h3>
        <table>
            <tr>
                <th>Entrada</th>
                <th>Variantes Generadas</th>
                <th>RazÃ³n</th>
            </tr>
            <tr>
                <td><code>"aceite 3000"</code></td>
                <td><code>aceite 3000, aceite 3.000, aceite 3000ml, aceite 3.000 ml, aceite 3000 ml</code></td>
                <td>D1 distingue "3.000" vs "3000"</td>
            </tr>
            <tr>
                <td><code>"leche 1100"</code></td>
                <td><code>leche 1100, leche 1.100, leche 1100ml, leche 1.100 ml</code></td>
                <td>Formato colombiano de miles</td>
            </tr>
            <tr>
                <td><code>"arroz 500"</code></td>
                <td><code>arroz 500, arroz 500ml, arroz 500 ml</code></td>
                <td>Sin punto (< 4 dÃ­gitos)</td>
            </tr>
        </table>

        <!-- â•â•â•â•â•â•â• 6. API ENDPOINTS â•â•â•â•â•â•â• -->
        <h2>6. API REST â€” Endpoints</h2>
        <table>
            <tr>
                <th>MÃ©todo</th>
                <th>Ruta</th>
                <th>DescripciÃ³n</th>
                <th>Respuesta</th>
            </tr>
            <tr>
                <td><code>GET</code></td>
                <td><code>/api/get_products.php</code></td>
                <td>Lista TODOS los productos con el precio mÃ¡s reciente por tienda</td>
                <td>JSON array: <code>[{id, nombre, categoria, precios: {D1: N, OLIMPICA: N, ...}}]</code></td>
            </tr>
            <tr>
                <td><code>POST</code></td>
                <td><code>/api/import_csv.php</code></td>
                <td>Importar productos desde archivo CSV</td>
                <td>JSON con contador de registros importados</td>
            </tr>
        </table>

        <h3>6.1. Query SQL de get_products.php</h3>
        <pre>SELECT p.id, p.nombre_personalizado as nombre, p.categoria,
  (SELECT precio FROM precios_tiendas
   WHERE producto_id = p.id AND tienda = 'D1'
   ORDER BY fecha_registro DESC LIMIT 1) as precio_d1,
  -- ... (subconsulta por cada tienda)
FROM productos p
ORDER BY
  CASE WHEN p.categoria IN ('CARNES','VERDURAS') THEN 0 ELSE 1 END,
  p.categoria, p.nombre_personalizado</pre>

        <!-- â•â•â•â•â•â•â• 7. SELECTORES CSS VERIFICADOS â•â•â•â•â•â•â• -->
        <h2>7. Registro de Selectores CSS por Tienda</h2>
        <table>
            <tr>
                <th>Tienda</th>
                <th>Uso</th>
                <th>Selector</th>
                <th>Verificado</th>
            </tr>
            <tr>
                <td>OlÃ­mpica</td>
                <td>Precio (producto)</td>
                <td><code>.olimpica-dinamic-flags-0-x-currencyContainer</code></td>
                <td>âœ… 15/02/26</td>
            </tr>
            <tr>
                <td>OlÃ­mpica</td>
                <td>Trigger ubicaciÃ³n</td>
                <td><code>.vtex-modal-layout-0-x-triggerContainer--location-delivery-info</code></td>
                <td>âœ… 15/02/26</td>
            </tr>
            <tr>
                <td>Megatiendas</td>
                <td>Precio (producto)</td>
                <td><code>.vtex-product-price-1-x-sellingPriceValue</code></td>
                <td>âœ… 15/02/26</td>
            </tr>
            <tr>
                <td>D1</td>
                <td>Precio (producto)</td>
                <td><code>.base__price</code></td>
                <td>âš  Pendiente</td>
            </tr>
            <tr>
                <td>D1</td>
                <td>Cards bÃºsqueda</td>
                <td><code>styles__StyledCard-sc-*</code> (dinÃ¡mico)</td>
                <td>ğŸ”§ En progreso</td>
            </tr>
        </table>

        <!-- â•â•â•â•â•â•â• 8. CONFIGURACIÃ“N LOCAL â•â•â•â•â•â•â• -->
        <h2>8. ConfiguraciÃ³n de Entorno Local</h2>
        <table>
            <tr>
                <th>Componente</th>
                <th>Valor</th>
            </tr>
            <tr>
                <td>Servidor</td>
                <td>XAMPP (Apache + MySQL)</td>
            </tr>
            <tr>
                <td>DB Host</td>
                <td><code>127.0.0.1:3306</code></td>
            </tr>
            <tr>
                <td>DB User</td>
                <td><code>root</code> (sin contraseÃ±a)</td>
            </tr>
            <tr>
                <td>DB Name</td>
                <td><code>despensa_inteligente</code></td>
            </tr>
            <tr>
                <td>Proyecto</td>
                <td><code>D:\Documentos\Proyectos ADSO\despensa_inteligente</code></td>
            </tr>
            <tr>
                <td>Symlink XAMPP</td>
                <td><code>C:\xampp\htdocs\despensa_inteligente â†’ D:\...</code></td>
            </tr>
            <tr>
                <td>Repositorio</td>
                <td><code>github.com/modusaxon-hub/despensa_inteligente</code></td>
            </tr>
        </table>

        <footer class="footer">
            Documento generado por Agente Documentador TÃ©cnico Pro | 15 de Febrero 2026 | Despensa Inteligente â€” Santa
            Marta
        </footer>
    </div>
</body>

</html>